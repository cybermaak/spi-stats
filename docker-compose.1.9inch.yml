services:
  spi-stats:
    build: .
    image: spi-stats
    privileged: true
    devices:
      - /dev/mem:/dev/mem
      - /dev/gpiomem:/dev/gpiomem
      - /dev/spidev0.0:/dev/spidev0.0
      - /dev/spidev0.1:/dev/spidev0.1
    volumes:
      - /proc:/host/proc:ro # Mount host's /proc to /host/proc to pull host stats
      - /:/host/disk_root:ro # Mount host's root disk to get host disk stats
    restart: unless-stopped
    network_mode: host
    healthcheck:
      test: [ "CMD", "pgrep", "-f", "python3 /app/src/stats.py" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    environment:
      - PROCFS_PATH=/host/proc
      - DISK_ROOT=/host/disk_root
      # 1.9" 170x320 ST7789 Display Configuration
      - SCREEN_WIDTH=170
      - SCREEN_HEIGHT=320
      - DISPLAY_ROTATION=270
      - DISPLAY_X_OFFSET=35
      - DISPLAY_Y_OFFSET=0
      # Larger font sizes for larger screen
      - TITLE_FONT_SIZE=24
      - STATS_FONT_SIZE=22